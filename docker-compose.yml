services:

  first:
    restart: always
    container_name: first
    build:
      context: ./first
      dockerfile: Dockerfile
    labels:
      - traefik.enable=true
      - api.insecure=true
      - traefik.http.services.app.loadbalancer.server.port=8081
      - traefik.http.routers.first.entrypoints=http
      - traefik.http.routers.first.rule=Host(`first.codewiser.online`)
      # configure https
      - traefik.http.routers.first.entrypoints=https
      - traefik.http.routers.first.rule=Host(`first.ibhaskar.com`)
      - traefik.http.routers.first.tls=true
      - traefik.http.routers.first.tls.certresolver=le
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      # Middleware to redirect HTTP to HTTPS
      - traefik.http.routers.app-http.middlewares=https-redirect
      - traefik.docker.network=towapp
    command: [ "node", "app.js" ]
    networks:
      - towapp

  second:
    restart: always
    container_name: second
    build:
      context: ./second
      dockerfile: Dockerfile
    labels:
      - traefik.enable=true
      - api.insecure=true
      - traefik.http.services.app.loadbalancer.server.port=8082
      - traefik.http.routers.second.entrypoints=http
      - traefik.http.routers.second.rule=Host(`second.ibhaskar.online`)
      - traefik.http.routers.second.entrypoints=https
      - traefik.http.routers.second.rule=Host(`second.ibhaskar.com`)
      - traefik.http.routers.second.tls=true
      - traefik.http.routers.second.tls.certresolver=le
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.docker.network=towapp
    command: [ "node", "server.js" ]
    networks:
      - towapp

networks:
  towapp:
    external: true
